stages:
  - pre-analysis
  - test
  - package
  - deploy
  - publish

image: gitlab.lrz.de:5005/i4/software/docker-images/python3.9-poetry

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ".venv"

python:quality:
  artifacts:
    reports:
      cobertura: cobertura.xml
      junit: mypy.xml
    expire_in: 10 days
  coverage: '/line-rate="0.([0-9]{1,2})\d*"/'
  needs: [ ]
  script:
    - poetry install
    - poetry run mypy --cobertura-xml-report=. --junit-xml=mypy.xml --pretty ./sharelatex_versioning
    - head -n 1 cobertura.xml
  stage: pre-analysis
  rules: &python-rules
    -   changes:
          - "sharelatex_versioning/**.py"
          - .gitlab-ci.yml
    -   if: '$CI_COMMIT_BRANCH == "main"'
    -   if: '$CI_COMMIT_BRANCH == "development"'
    -   if: '$CI_COMMIT_TAG'

python:test:
  artifacts:
    reports:
      cobertura: coverage.xml
      junit: report.xml
    expire_in: 10 days
  coverage: '/line-rate="0.([0-9]{1,2})\d*"/'
  needs:
  - python:quality
  rules: *python-rules
  script:
    - poetry install
    - poetry run pytest --junitxml report.xml --cov=sharelatex_versioning --cov-report xml ./sharelatex_versioning/tests
    - head -n 2 coverage.xml >> t.txt
    - tail -n 1 t.txt >> s.txt
    - cat s.txt
  stage: test

python:package:
  artifacts:
    paths:
      - dist
    expire_in: 3 days
  needs:
    - python:test
  rules: &package-rules
    - if: '$CI_COMMIT_TAG'
  script:
    - poetry install --no-dev
    - poetry build
  stage: package

python:deploy:
    rules: *package-rules
    script:
        - poetry config repositories.lrz https://gitlab.lrz.de/api/v4/projects/${CI_PROJECT_ID}/packages/pypi
        - poetry publish --repository lrz --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD
    stage: deploy
    needs:
        - python:package

pages:
  artifacts:
    paths:
      - public
  needs:
    - python:test
  rules: *python-rules
  script:
    - mkdir public
    - poetry install
    - poetry run mypy --html-report ./public/mypy ./sharelatex_versioning
    - poetry run pytest --cov=sharelatex_versioning --cov-branch --cov-report=html ./sharelatex_versioning/tests
    - mv htmlcov public
  stage: publish
